# 07: Architectural Decision Log

This document serves as an immutable log of all significant architectural and design decisions made throughout the project. Each entry details the decision and the rationale behind it.

| # | Decision | Rationale & Context | Status |
| :- | :--- | :--- | :--- |
| **ADR-001** | **Use a Progressive Web App (PWA) over a native mobile app.** | To provide a native-app-like experience (installable, notifications) while avoiding the complexity, cost, and review processes of the Apple App Store and Google Play Store. This allows for rapid, cross-platform deployment. | Accepted |
| **ADR-002** | **Implement a Polymorphic User model instead of a single User table.** | A single `User` table becomes wide and sparse (full of `NULL`s) as we add role-specific fields. By using a core `User` table for authentication and separate `Parent` and `Supervisor` tables for profile data, we achieve a cleaner, more scalable, and maintainable database schema. | Accepted |
| **ADR-003** | **Use auto-generated UUIDs as Primary Keys, not National IDs.** | A primary key must be stable and should never change. A National ID can be entered incorrectly and require updating. Using a meaningless UUID as the internal PK and a `nationalId` as a separate, unique business identifier is more secure (avoids exposing PII in APIs) and robust. | Accepted |
| **ADR-004** | **Store identifiers (e.g., National ID, Phone Numbers) as `String` type.** | These values are not used for mathematical calculations. Storing them as `String` correctly handles leading zeros and future-proofs the schema against format changes (e.g., including a dash or letter), which is an industry best practice. | Accepted |
| **ADR-005** | **Adopt the Repository Pattern in the backend.** | To separate the business logic in controllers from the data access logic. This makes the code cleaner, more organized, easier to test, and more maintainable. The controller asks "what" it wants, and the repository handles "how" to get it from the database. | Accepted |
| **ADR-006** | **Handle Production DB Migrations with a Two-Phase Strategy.** | To add a required column to a live database without data loss, we first migrate to an optional column, run a script to backfill the data for existing rows, and only then migrate to make the column required. This is the professional standard for zero-downtime, zero-data-loss migrations. | Accepted |
| **ADR-007** | **Implement detailed, field-level frontend validation.** | A generic "Validation Failed" error provides a poor user experience. The backend provides detailed, field-specific errors. The frontend must parse these and display them directly under the corresponding input field, guiding the user to a quick and easy correction. | Accepted |
| **ADR-008** | **Make backend validation Unicode-aware.** | Initial validation for names only accepted English characters (`a-zA-Z`). This was updated to include the Arabic character set (`\u0600-\u06FF`) to properly support the project's bilingual requirements and provide a correct experience for all users. | Accepted |
| **ADR-009** | **Place Driver information directly on the `Bus` model.** | The driver is not a user of the system (they don't log in). Creating a separate `Driver` table would be over-engineering for the current requirements. Attaching their info to the `Bus` is a pragmatic and efficient solution. | Accepted |
| **ADR-010**| **Always use the *profile-specific ID* for polymorphic relations.** | A critical bug occurred where the frontend was sending the `user.id` when assigning a supervisor to a bus. The backend correctly requires the `supervisor.id`. This serves as a critical reminder that when relating models to a polymorphic user, the foreign key must reference the *specific profile table* (e.g., `supervisors` or `parents`), not the generic `users` table. | Accepted | 